package main

import (
	"fmt"
	"net"
	"sort"
	"strings"
	"time"
)

type host struct {
	name          string
	portsExpected []int // ports that are expected to be open
	portsOpen     []int // ports that are actually open
}

func (h *host) scan() {
	ports := make(chan int)
	results := make(chan int)

	for i := 0; i < 100; i++ {
		go scanner(h.name, ports, results)
	}

	go func() {
		for p := range portsToScan {
			ports <- p
		}
	}()

	var openports []int

	for range portsToScan {
		port := <-results
		if port != 0 {
			openports = append(openports, port)
		}
	}

	sort.Ints(openports)
	h.portsOpen = openports
}

// eval evaluates expected and actual open ports
func (h *host) eval() {
	var out []string
	for _, p := range h.portsOpen {
		var s string
		if contains(h.portsExpected, p) {
			s = fmt.Sprintf("%d ✓", p)
		} else {
			s = fmt.Sprintf("%d ✗", p)
		}
		out = append(out, s)
	}
	fmt.Printf("%-25s %s\n", h.name, strings.Join(out, " "))
}

func scanner(host string, ports, results chan int) {
	for port := range ports {
		if canConnect(host, port) {
			results <- port
		} else {
			results <- 0
		}
	}
}

func canConnect(host string, port int) bool {
	addr := fmt.Sprintf("%s:%d", host, port)
	for _, timeout := range []int{50, 100, 300} {
		conn, err := net.DialTimeout("tcp", addr, time.Millisecond*time.Duration(timeout))
		if err == nil {
			conn.Close()
			return true
		}
	}
	return false
}

func contains(s []int, e int) bool {
	for _, a := range s {
		if a == e {
			return true
		}
	}
	return false
}

/*
Generated from nmap's list of ports like this:
grep -v '^#' /usr/local/share/nmap/nmap-services | \
perl -lane '@F[2] > 0.0001 && print' | \
perl -lane '@F[1] =~ /(\d+)\/tcp/ && print $1' | \
sort -n | uniq
*/
var portsToScan = []int{
	1,
	3,
	4,
	6,
	7,
	9,
	13,
	17,
	19,
	20,
	21,
	22,
	23,
	24,
	25,
	26,
	27,
	30,
	32,
	33,
	37,
	42,
	43,
	49,
	53,
	55,
	57,
	70,
	77,
	79,
	80,
	81,
	82,
	83,
	84,
	85,
	86,
	87,
	88,
	89,
	90,
	99,
	100,
	102,
	106,
	109,
	110,
	111,
	113,
	119,
	123,
	125,
	127,
	135,
	139,
	143,
	144,
	146,
	157,
	161,
	163,
	179,
	199,
	210,
	211,
	212,
	220,
	222,
	223,
	250,
	251,
	254,
	255,
	256,
	259,
	264,
	280,
	301,
	306,
	311,
	333,
	340,
	366,
	389,
	406,
	407,
	416,
	417,
	419,
	425,
	427,
	441,
	442,
	443,
	444,
	445,
	447,
	458,
	464,
	465,
	475,
	481,
	497,
	500,
	502,
	512,
	513,
	514,
	515,
	523,
	524,
	540,
	541,
	543,
	544,
	545,
	548,
	554,
	555,
	556,
	557,
	563,
	587,
	593,
	610,
	616,
	617,
	623,
	625,
	631,
	636,
	639,
	646,
	648,
	657,
	666,
	667,
	668,
	674,
	683,
	684,
	687,
	691,
	700,
	701,
	705,
	709,
	710,
	711,
	713,
	714,
	720,
	722,
	725,
	726,
	732,
	748,
	749,
	765,
	777,
	780,
	783,
	787,
	792,
	800,
	801,
	803,
	808,
	825,
	829,
	840,
	843,
	856,
	873,
	874,
	880,
	888,
	898,
	900,
	901,
	902,
	903,
	904,
	911,
	912,
	913,
	930,
	931,
	943,
	953,
	980,
	981,
	987,
	990,
	992,
	993,
	995,
	999,
	1000,
	1001,
	1002,
	1006,
	1007,
	1008,
	1009,
	1010,
	1011,
	1013,
	1020,
	1021,
	1022,
	1023,
	1024,
	1025,
	1026,
	1027,
	1028,
	1029,
	1030,
	1031,
	1032,
	1033,
	1034,
	1035,
	1036,
	1037,
	1038,
	1039,
	1040,
	1041,
	1042,
	1043,
	1044,
	1045,
	1046,
	1047,
	1048,
	1049,
	1050,
	1051,
	1052,
	1053,
	1054,
	1055,
	1056,
	1057,
	1058,
	1059,
	1060,
	1061,
	1062,
	1063,
	1064,
	1065,
	1066,
	1067,
	1068,
	1069,
	1070,
	1071,
	1072,
	1073,
	1074,
	1075,
	1076,
	1077,
	1078,
	1079,
	1080,
	1081,
	1082,
	1083,
	1084,
	1085,
	1086,
	1087,
	1088,
	1089,
	1090,
	1091,
	1092,
	1093,
	1094,
	1095,
	1096,
	1097,
	1098,
	1099,
	1100,
	1102,
	1103,
	1104,
	1105,
	1106,
	1107,
	1108,
	1109,
	1110,
	1111,
	1112,
	1113,
	1114,
	1117,
	1119,
	1121,
	1122,
	1123,
	1124,
	1126,
	1130,
	1131,
	1132,
	1137,
	1138,
	1141,
	1145,
	1147,
	1148,
	1149,
	1151,
	1152,
	1154,
	1158,
	1163,
	1164,
	1165,
	1166,
	1169,
	1174,
	1175,
	1183,
	1185,
	1186,
	1187,
	1192,
	1198,
	1199,
	1201,
	1212,
	1213,
	1216,
	1217,
	1218,
	1220,
	1222,
	1233,
	1234,
	1236,
	1241,
	1244,
	1247,
	1248,
	1259,
	1270,
	1271,
	1272,
	1277,
	1287,
	1296,
	1300,
	1301,
	1309,
	1310,
	1311,
	1322,
	1328,
	1334,
	1347,
	1350,
	1351,
	1352,
	1417,
	1433,
	1434,
	1443,
	1455,
	1461,
	1494,
	1500,
	1501,
	1503,
	1516,
	1521,
	1524,
	1526,
	1533,
	1547,
	1550,
	1556,
	1580,
	1583,
	1594,
	1600,
	1641,
	1658,
	1666,
	1687,
	1688,
	1700,
	1717,
	1718,
	1719,
	1720,
	1721,
	1723,
	1755,
	1761,
	1782,
	1783,
	1801,
	1805,
	1812,
	1839,
	1840,
	1862,
	1863,
	1864,
	1875,
	1900,
	1914,
	1935,
	1947,
	1971,
	1972,
	1974,
	1984,
	1998,
	1999,
	2000,
	2001,
	2002,
	2003,
	2004,
	2005,
	2006,
	2007,
	2008,
	2009,
	2010,
	2011,
	2012,
	2013,
	2020,
	2021,
	2022,
	2030,
	2033,
	2034,
	2035,
	2038,
	2040,
	2041,
	2042,
	2043,
	2044,
	2045,
	2046,
	2047,
	2048,
	2049,
	2065,
	2067,
	2068,
	2099,
	2100,
	2103,
	2105,
	2106,
	2107,
	2111,
	2119,
	2121,
	2126,
	2135,
	2144,
	2160,
	2161,
	2170,
	2179,
	2190,
	2191,
	2196,
	2200,
	2222,
	2232,
	2241,
	2251,
	2260,
	2288,
	2301,
	2323,
	2366,
	2381,
	2382,
	2383,
	2393,
	2394,
	2399,
	2401,
	2433,
	2492,
	2500,
	2501,
	2522,
	2525,
	2557,
	2601,
	2602,
	2604,
	2605,
	2607,
	2608,
	2628,
	2638,
	2701,
	2702,
	2710,
	2717,
	2718,
	2725,
	2800,
	2809,
	2811,
	2869,
	2875,
	2909,
	2910,
	2920,
	2967,
	2968,
	2998,
	3000,
	3001,
	3003,
	3005,
	3006,
	3007,
	3011,
	3013,
	3017,
	3025,
	3030,
	3031,
	3050,
	3052,
	3071,
	3077,
	3119,
	3128,
	3162,
	3168,
	3211,
	3221,
	3260,
	3261,
	3268,
	3269,
	3283,
	3299,
	3300,
	3301,
	3304,
	3306,
	3307,
	3322,
	3323,
	3324,
	3325,
	3333,
	3351,
	3367,
	3369,
	3370,
	3371,
	3372,
	3376,
	3389,
	3390,
	3400,
	3404,
	3410,
	3476,
	3493,
	3514,
	3517,
	3527,
	3546,
	3551,
	3580,
	3659,
	3684,
	3689,
	3690,
	3697,
	3700,
	3703,
	3731,
	3737,
	3766,
	3784,
	3792,
	3800,
	3801,
	3808,
	3809,
	3814,
	3820,
	3824,
	3826,
	3827,
	3828,
	3846,
	3848,
	3849,
	3851,
	3852,
	3853,
	3859,
	3863,
	3869,
	3870,
	3871,
	3872,
	3878,
	3880,
	3888,
	3889,
	3905,
	3907,
	3914,
	3916,
	3918,
	3920,
	3929,
	3931,
	3941,
	3944,
	3945,
	3957,
	3963,
	3968,
	3969,
	3971,
	3972,
	3981,
	3986,
	3990,
	3993,
	3994,
	3995,
	3998,
	4000,
	4001,
	4002,
	4003,
	4004,
	4005,
	4006,
	4009,
	4040,
	4045,
	4080,
	4096,
	4111,
	4125,
	4126,
	4129,
	4143,
	4147,
	4164,
	4200,
	4224,
	4242,
	4252,
	4279,
	4321,
	4333,
	4343,
	4430,
	4443,
	4444,
	4445,
	4446,
	4449,
	4550,
	4555,
	4559,
	4567,
	4600,
	4658,
	4662,
	4848,
	4875,
	4899,
	4900,
	4949,
	4998,
	5000,
	5001,
	5002,
	5003,
	5004,
	5009,
	5010,
	5030,
	5033,
	5040,
	5050,
	5051,
	5054,
	5060,
	5061,
	5063,
	5074,
	5080,
	5081,
	5087,
	5100,
	5101,
	5102,
	5120,
	5151,
	5190,
	5200,
	5212,
	5214,
	5221,
	5222,
	5223,
	5225,
	5226,
	5242,
	5269,
	5279,
	5280,
	5298,
	5339,
	5353,
	5357,
	5405,
	5414,
	5431,
	5432,
	5440,
	5500,
	5501,
	5510,
	5520,
	5544,
	5550,
	5555,
	5560,
	5566,
	5631,
	5633,
	5666,
	5678,
	5679,
	5680,
	5718,
	5730,
	5800,
	5801,
	5802,
	5803,
	5807,
	5810,
	5811,
	5812,
	5815,
	5818,
	5822,
	5823,
	5825,
	5850,
	5859,
	5862,
	5868,
	5869,
	5877,
	5899,
	5900,
	5901,
	5902,
	5903,
	5904,
	5905,
	5906,
	5907,
	5909,
	5910,
	5911,
	5914,
	5915,
	5918,
	5922,
	5925,
	5938,
	5940,
	5950,
	5952,
	5959,
	5960,
	5961,
	5962,
	5963,
	5968,
	5981,
	5987,
	5988,
	5989,
	5998,
	5999,
	6000,
	6001,
	6002,
	6003,
	6004,
	6005,
	6006,
	6007,
	6008,
	6009,
	6025,
	6051,
	6059,
	6060,
	6068,
	6100,
	6101,
	6103,
	6106,
	6112,
	6123,
	6129,
	6156,
	6203,
	6222,
	6247,
	6346,
	6389,
	6481,
	6500,
	6502,
	6504,
	6510,
	6520,
	6543,
	6547,
	6550,
	6565,
	6566,
	6567,
	6580,
	6600,
	6646,
	6666,
	6667,
	6668,
	6669,
	6689,
	6692,
	6699,
	6711,
	6732,
	6779,
	6788,
	6789,
	6792,
	6839,
	6881,
	6896,
	6901,
	6969,
	7000,
	7001,
	7002,
	7003,
	7004,
	7007,
	7010,
	7019,
	7024,
	7025,
	7050,
	7051,
	7070,
	7080,
	7100,
	7103,
	7106,
	7123,
	7200,
	7201,
	7241,
	7272,
	7278,
	7281,
	7402,
	7435,
	7438,
	7443,
	7496,
	7512,
	7625,
	7627,
	7676,
	7725,
	7741,
	7744,
	7749,
	7770,
	7777,
	7778,
	7800,
	7878,
	7900,
	7911,
	7913,
	7920,
	7921,
	7929,
	7937,
	7938,
	7999,
	8000,
	8001,
	8002,
	8007,
	8008,
	8009,
	8010,
	8011,
	8015,
	8016,
	8019,
	8021,
	8022,
	8031,
	8042,
	8045,
	8050,
	8080,
	8081,
	8082,
	8083,
	8084,
	8085,
	8086,
	8087,
	8088,
	8089,
	8090,
	8093,
	8095,
	8097,
	8098,
	8099,
	8100,
	8118,
	8180,
	8181,
	8189,
	8192,
	8193,
	8194,
	8200,
	8222,
	8254,
	8290,
	8291,
	8292,
	8293,
	8294,
	8300,
	8333,
	8383,
	8385,
	8400,
	8402,
	8443,
	8481,
	8500,
	8540,
	8600,
	8648,
	8649,
	8651,
	8652,
	8654,
	8675,
	8676,
	8686,
	8701,
	8765,
	8766,
	8800,
	8873,
	8877,
	8888,
	8889,
	8899,
	8987,
	8994,
	8996,
	9000,
	9001,
	9002,
	9003,
	9009,
	9010,
	9011,
	9040,
	9050,
	9071,
	9080,
	9081,
	9090,
	9091,
	9098,
	9099,
	9100,
	9101,
	9102,
	9103,
	9110,
	9111,
	9152,
	9191,
	9197,
	9198,
	9200,
	9207,
	9220,
	9290,
	9409,
	9415,
	9418,
	9443,
	9444,
	9485,
	9500,
	9501,
	9502,
	9503,
	9535,
	9575,
	9593,
	9594,
	9595,
	9600,
	9618,
	9621,
	9643,
	9666,
	9673,
	9815,
	9876,
	9877,
	9878,
	9898,
	9900,
	9914,
	9917,
	9929,
	9941,
	9943,
	9944,
	9968,
	9988,
	9992,
	9998,
	9999,
	10000,
	10001,
	10002,
	10003,
	10004,
	10005,
	10008,
	10009,
	10010,
	10011,
	10012,
	10022,
	10023,
	10024,
	10025,
	10034,
	10058,
	10082,
	10083,
	10160,
	10180,
	10215,
	10243,
	10566,
	10616,
	10617,
	10621,
	10626,
	10628,
	10629,
	10778,
	10873,
	11110,
	11111,
	11967,
	12000,
	12006,
	12021,
	12059,
	12174,
	12215,
	12262,
	12265,
	12345,
	12380,
	12452,
	13456,
	13722,
	13724,
	13782,
	13783,
	14000,
	14238,
	14441,
	14442,
	15000,
	15001,
	15002,
	15003,
	15004,
	15402,
	15660,
	15742,
	16000,
	16001,
	16012,
	16016,
	16018,
	16080,
	16113,
	16705,
	16800,
	16851,
	16992,
	16993,
	17595,
	17877,
	17988,
	18000,
	18018,
	18040,
	18101,
	18264,
	18988,
	19101,
	19283,
	19315,
	19350,
	19780,
	19801,
	19842,
	19900,
	20000,
	20002,
	20005,
	20031,
	20221,
	20222,
	20828,
	21571,
	21792,
	22222,
	22939,
	23052,
	23502,
	23796,
	24444,
	24800,
	25734,
	25735,
	26000,
	26214,
	26470,
	27000,
	27352,
	27353,
	27355,
	27356,
	27357,
	27715,
	28201,
	28211,
	29672,
	29831,
	30000,
	30005,
	30704,
	30718,
	30951,
	31038,
	31337,
	31727,
	32768,
	32769,
	32770,
	32771,
	32772,
	32773,
	32774,
	32775,
	32776,
	32777,
	32778,
	32779,
	32780,
	32781,
	32782,
	32783,
	32784,
	32785,
	32791,
	32792,
	32803,
	32816,
	32822,
	32835,
	33354,
	33453,
	33554,
	33899,
	34571,
	34572,
	34573,
	35500,
	35513,
	37839,
	38185,
	38188,
	38292,
	39136,
	39376,
	39659,
	40000,
	40193,
	40811,
	40911,
	41064,
	41511,
	41523,
	42510,
	44176,
	44442,
	44443,
	44501,
	44709,
	45100,
	46200,
	46996,
	47544,
	48080,
	49152,
	49153,
	49154,
	49155,
	49156,
	49157,
	49158,
	49159,
	49160,
	49161,
	49163,
	49164,
	49165,
	49167,
	49168,
	49171,
	49175,
	49176,
	49186,
	49195,
	49236,
	49400,
	49401,
	49999,
	50000,
	50001,
	50002,
	50003,
	50006,
	50050,
	50300,
	50389,
	50500,
	50636,
	50800,
	51103,
	51191,
	51413,
	51493,
	52660,
	52673,
	52710,
	52735,
	52822,
	52847,
	52848,
	52849,
	52850,
	52851,
	52853,
	52869,
	53211,
	53313,
	53314,
	53535,
	54045,
	54328,
	55020,
	55055,
	55056,
	55555,
	55576,
	55600,
	56737,
	56738,
	57294,
	57665,
	57797,
	58001,
	58002,
	58080,
	58630,
	58632,
	58838,
	59110,
	59200,
	59201,
	59202,
	60020,
	60123,
	60146,
	60443,
	60642,
	61532,
	61613,
	61900,
	62078,
	63331,
	64623,
	64680,
	65000,
	65129,
	65310,
	65389,
}
